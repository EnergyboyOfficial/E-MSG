<!-- public/chat.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Room</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div id="app" class="container">
    <h2>Welcome to the Chat Room, {{ currentUser }}!</h2>
    <ul id="messages">
      <li v-for="(message, index) in messages" :key="index">
        {{ message.user.username }}: {{ message.content }}
      </li>
    </ul>
    <div id="userList">
      <div v-for="(user, index) in userList" :key="index">{{ user.username }} connected</div>
    </div>
    <input v-model="messageInput" autocomplete="off" @keydown.enter="handleKeyPress" />
    <button @click="sendMessage">Send</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    new Vue({
      el: '#app',
      data: {
        currentUser: '',
        messageInput: '',
        messages: [],
        userList: []
      },
      mounted() {
        this.login(); // Auto-login when the page loads
      },
      methods: {
        addMessage(message) {
          this.messages.push(message);
        },
        sendMessage() {
          if (this.messageInput.trim() !== '') {
            socket.emit('message', this.messageInput);
            this.messageInput = '';
          }
        },
        handleKeyPress(event) {
          if (!this.currentUser && event.key === 'Enter') {
            this.login();
          } else if (event.key === 'Enter') {
            this.sendMessage();
          }
        },
        login() {
          const usernameInput = prompt('Enter your username:');
          if (usernameInput && usernameInput.trim() !== '') {
            this.currentUser = usernameInput.trim();
            socket.emit('login', this.currentUser);
            socket.emit('loadMessages', this.currentUser);
          } else {
            alert('Username cannot be empty. Please try again.');
          }
        }
      }
    });

    const socket = io();

    // Handle incoming messages
    socket.on('message', (message) => {
      this.addMessage(message);
    });

    // Handle user connections
    socket.on('userConnected', (user) => {
      this.userList.push(user);
    });

    // Handle user disconnections
    socket.on('userDisconnected', (user) => {
      this.userList = this.userList.filter((u) => u.id !== user.id);
    });

    // Load existing messages when connecting
    socket.on('loadMessages', (messages) => {
      this.messages = messages;
    });
  </script>
</body>
</html>
